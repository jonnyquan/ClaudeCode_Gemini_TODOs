# BitAgent 测试规范约定 (Testing Convention)

> **IMPERATIVE**: 本文档定义了 BitAgent 项目中所有测试的编写标准和最佳实践。所有代码提交都应遵守本约定，以确保系统的健壮性、可维护性和可靠性。

## 1. 🧪 测试哲学 (Testing Philosophy)

我们编写测试不仅是为了发现 Bug，更是为了：
- **建立信心 (Build Confidence)**: 让我们能够自信地进行重构和添加新功能，而不用担心破坏现有逻辑。
- **防止回归 (Prevent Regressions)**: 确保一度被修复的 Bug 不会再次出现。
- **提供文档 (Provide Documentation)**: 清晰的测试是用例的活文档，展示了代码的预期行为。
- **驱动设计 (Drive Design)**: 编写可测试的代码通常会促使我们写出更模块化、更低耦合的优秀代码。

## 2. 🔬 测试类型 (Types of Tests)

我们的项目主要包含以下几种测试类型：

### 2.1. 单元测试 (Unit Tests)
- **目标**: 验证一个独立的、最小的功能单元（如一个函数、一个类的方法）的行为是否符合预期。
- **要求**:
    - **快速**: 运行速度必须非常快。
    - **隔离**: **必须**使用模拟（Mocking）来隔离所有外部依赖，如文件系统、网络请求、数据库、消息总线等。
    - **存放位置**: `tests/` 目录下，与被测试的模块对应。

### 2.2. 集成测试 (Integration Tests)
- **目标**: 验证多个组件（如多个 Agent）在一起工作时是否正确。
- **要求**:
    - **专注交互**: 重点测试组件间的接口和数据流，例如一个 Agent 发布事件，另一个 Agent 能否正确接收和处理。
    - **有限模拟**: 可以使用真实的内部组件（如 `InMemoryBus`），但仍应模拟最外部的依赖（如交易所 API）。
    - **存放位置**: `tests/` 目录下，文件名应能体现其集成测试的性质，如 `test_data_pipeline_integration.py`。

### 2.3. 端到端测试 (End-to-End / E2E Tests)
- **目标**: 验证一个完整的业务流程是否符合预期。例如，从 `StrategyLearnerAgent` 发现策略，到 `ChiefAgent` 批准，再到回测执行并产生结果的整个流程。
- **要求**:
    - **模拟真实环境**: 尽可能少地使用模拟，使用接近生产的配置。
    - **独立运行**: E2E 测试通常很慢，应与单元/集成测试分开��行。
    - **存放位置**: `tests/e2e/` (待创建)。

## 3. 🗓️ 测试时机 (When to Test)

- **新功能**: **必须**为所有新的业务逻辑编写单元测试或集成测试。
- **Bug 修复**: **必须**首先编写一个能够复现该 Bug 的测试（此时该测试应为失败状态），然后再进行修复，直到该测试通过。这确保了 Bug 不会回归。
- **重构**: 在进行代码重构之前，**必须**确保相关的代码有良好的测试覆盖。重构后，所有测试都应该依然通过，且不应修改测试逻辑本身。

## 4. ✍️ 规范与约定 (Conventions)

### 4.1. 文件与命名 (Location & Naming)
- **目录**: 所有测试代码都必须放在根目录的 `tests/` 文件夹下。
- **文件名**: 测试文件名必须以 `test_` 开头，例如 `test_strategy_learner_agent.py`。
- **函数/方法名**: 测试函数名必须以 `test_` 开头，并清晰地描述其测试的场景和预期结果，例如 `test_calculate_pnl_with_positive_result`。

### 4.2. 测试结构 (Test Structure)
- **AAA 模式**: 所有测试用例都应遵循 **Arrange-Act-Assert** (AAA) 模式：
    1.  **Arrange (准备)**: 设置测试所需的所有前提条件，如初始化对象、准备模拟数据、设置 Mock 等。
    2.  **Act (��行)**: 调用被测试的代码或执行被测试的动作。
    3.  **Assert (断言)**: 验证执行结果是否与预期相符。
- **保持独立**: 每个测试用例都必须是完全独立的，其执行结果不应依赖于其他测试用例的执行顺序或状态。

### 4.3. 最佳实践 (Best Practices)
- **使用 Mock**: 广泛使用 `unittest.mock` (特别是 `@patch`) 来隔离依赖。
- **清晰断言**: 使用最精确的断言方法，例如用 `assertEqual(a, b)` 而不是 `assertTrue(a == b)`，用 `assertIsNone(x)` 而不是 `assertTrue(x is None)`。
- **单一职责**: 每个测试用例应尽可能只测试一个具体的行为或场景。
- **可读性**: 测试代码应像普通代码一样易于阅读和维护。

## 5. 🚀 如何运行测试 (Running Tests)

- **运行所有测试**:
  ```bash
  ./.venv/bin/python -m unittest discover tests/
  ```
- **运行单个文件**:
  ```bash
  ./.venv/bin/python -m unittest tests/test_some_agent.py
  ```

---
*版本: 1.0*
*本文件是保证我们代码质量的基石，所有开发者都应严格遵守。*
